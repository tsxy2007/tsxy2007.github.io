---
title: DirectX12-Phong光照
date: 2022-01-23 15:27:40
tags: Direct3D
---
我们之前的工作可以让我们看到一个立方体，但是却不真实，想要真实效果我们需要添加光照。光照分为局部光照和全局光照。由于全局光照太复杂，我们这里只考虑局部光照，即每个物体光照皆独立于其他物体。

## 法向量

平面发线是一种描述多边形朝向的单位向量。曲面法线是一种垂直于曲面上一点处切平面的单位向量。
### 计算法向量
三角形$\triangle P_0P_1P_2$我们首先计算位于三角形边上的两个向量：

$$u = P_1 - P_0$$
$$v = P_2 - P_0$$
那么此三角形的发线为：
$$n = \frac{u \times v}{||u \times v||}$$
对于可微的光滑曲面而言，我们可以利用微积分方面的知识来求出曲面点处的法线。我们用**求顶点法线平均值**的计算法线。
$$n_{avg} = \frac{n_0 + n_1+n_2+n_3}{||n_0 + n_1+n_2+n_3||}$$
### 变换法向量
切向量 $u = v_1-v_0$正交于法向量n.如果对此应用一个非等比缩放变换A。变换后的切向量$uA = v_1A-v_0A$没能继续保持与变换后法向量$nA$的正交性。求出一个变换矩阵B通过它变换法向量，是经过矩阵A变换后的切向量与法向量重归正交的关系$uA \times nB = 0$推导如下：

$$u \ast n=0 //切向量正交于法向量$$ 
$$un^T =0 // 将点积改写为矩阵乘法$$ 
$$u(AA^{-1})n^T=0//插入单位矩阵I=AA^{-1}$$
$$(uA)(A^{-1}n^T)=0//根据矩阵乘法运算的结合律$$
$$(uA)((A^{-1}n^T)^T)^T=0//根据转置矩阵的性质(A^T)^T = A$$
$$(uA)(n(A^{-1})^T)^T=0//根据转置矩阵的性质(AB)^T = B^TA^T$$
$$(uA)(n(A^{-1})^T)=0//将矩阵乘法改写为点积的形式$$
$$(uA)(nB)=0//变换后的切向量正交于变换后的法向量$$

**代码如下**
```
static XMMATRIX InverseTranspose(CXMMATRIX M)
{
    XMMATRIX A = M;
    A.r[3] = XMVectorSet(0.f,0.f,0.f,1.f);// 去掉位移 的影响
    XMVECTOR det = XMMatrixDeterminant(A);
    return XMMatrixTranspose(XMMatrixInverse(&det,A));
}
```
## 参与光照计算的一些关键向量
E： 观察者的观察位置
P:  观察点
v： 观察视线
n： 位于表面点P处的法线
I： 光线入射方向

### 朗伯余弦定律

**辐射通量**： 光源每秒发出的（光）能量；

**辐射度**：   单位面积上的辐射通量密度。

垂直射向单位表面辐射度强度为$A_1$ 则光照密度为 $E_1 = \frac{P}{A_1}$

斜向射向单位表面辐射度强度为$A_2$ 则光照密度为 $E_2 = \frac{P}{A_2}$

光照强度为 P

$A_1$与$A_2$的关系为：$\cos{\theta} = \frac{A_1}{A_2} \Longrightarrow \frac{1}{A_2}=\frac{\cos{\theta}}{A_1}$

所以：

$$

E_2 =   \frac{P}{A_2}
    =   \frac{P}{A_1}\cos{\theta}
    =   E_1\cos{\theta} 
    =   E_1(n \ast L)

$$

考虑到光线照射到表面另一侧的情况（此时，点积的结果为负值）。我们用max函数来钳制缩放因子的取值范围。
$$f(\theta)=max(\cos{\theta},0)=max(L \ast n,0)$$

### 漫反射光照

$$C_d = max(L \ast n,0) \ast B_L \bigotimes m_d$$
1.  $B_L$:入射光量
2.  $m_d$:漫反射反照率

### 环境光照

$$C_a=A_L\bigotimes m_d$$
1. $A_L$:表面收到的间接光量
2. $m_d$: 漫反射反照率我们借用此值表明被表面反射的入射环境光量

### 镜面光照（高光）
#### 菲涅耳效应
**菲涅耳方程**： 以数学方法描述了入射光线被反射的百分比，即$0\leq R_F \leq 1$ 如果$R_F$是反射光量，则$1-R_F$为折射光量。我们一般不用这个公式，一般用**石里克近似**法代替如下：
$$R_F(\theta_i)=R_F(0^o)+(1-R_F(0^o))(1-\cos{\theta_i})^5$$
我们将菲涅尔效应简洁的概括为：**反射光量取决于材质$R_F(0^o)$以及法线与光向量之间的夹角**

**表面粗糙度**： 物体的表面一般还有一定的粗糙度，我们用一下公式表示：
$$
p(\theta) = \cos^m{(\theta_h)}
          = \cos^m{(n \ast h)}
$$
为了光能守恒我们添加归一化因子：$\frac{m+8}{8}$
添加后的公式如下：
$$
C_s = max(L \ast n,0) \ast B_L \bigotimes R_F(\alpha_h) \frac{m+8}{8}\lgroup n \ast h \rgroup ^ m
$$

### 总公式
$$
LitColor = C_a + C_d + C_s \\
 \\
= A_L\bigotimes m_d  + max(L \ast n,0) \ast B_L \bigotimes \lgroup m_d + R_F(\alpha_h) \frac{m+8}{8}(n \ast h)^m \rgroup
$$
1. L:   指向光源的光向量.
2. n:   表面法向量
3. h:   列于光向量与观察向量(由表面点指向观察点的单位向量)之间的中间向量.
4. $A_L$: 表示入射的环境光量
5. $B_L$: 表示入射的直射光量。
6. $m_d$: 指示根据表面漫反射率而反射的入射光量。
7. $L \ast n$: 朗伯余弦定律。
8. $\alpha_h$: 中间向量h与光量L之间的夹角。
9. $R_F(\alpha_h)$: 根据菲涅尔效应，关于中间向量h所反射到观察者眼中的光量
10. $m$: 控制表面的粗糙度
11. $(n \ast h)^m$: 指定法线h与宏观表面法线n之间夹角为$\theta_h$的所有微平面片段。
12. $\frac{m+8}{8}$: 在镜面反射过程中，为模拟能量守恒所采用的归一化因子。